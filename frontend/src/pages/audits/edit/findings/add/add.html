<div>
    <breadcrumb
    buttons
    :title="`${$parent.audit.name} (${$parent.audit.auditType || 'Audit Type not set'})`"
    :state="parentState"
    :approvals="parentApprovals"
    :path="($parent.audit.parentId) ? `/audits/${$parent.audit.parentId}` : ''"
    :path-name="($parent.audit.type === 'retest') ? $t('originalAudit') : ($parent.audit.type === 'default') ? $t('multi') : ''"
    >
    </breadcrumb>

<div class="row content q-pa-md">
    <div class="col-xl-10 offset-xl-1 col-12">
        <q-table
        class="sticky-header-table-addfinding"
        :columns="dtVulnHeaders"
        :data="vulnerabilities"
        :filter="search"
        :filter-method="customFilter"
        :pagination.sync="vulnPagination"
        row-key="_id"
        separator="none"
        :loading="loading"
        >
            <template v-slot:top>
                <q-select 
                class="col-md-2"
                v-model="dtLanguage" 
                :label="$t('language')" 
                :options="languages" 
                option-value="locale" 
                option-label="language"
                map-options
                emit-value
                @input="getVulnerabilities"
                options-sanitize
                outlined
                />
                <q-space />
                <q-btn
                unelevated
                color="light-blue"
                no-caps
                :label="$t('createVulnerabilityIA')"
                @click="showAiModal()"
                />
            </template>

            <template v-slot:top-row="props">
                <q-tr>
                    <q-td style="width: 60%">
                        <q-input 
                        dense
                        :label="$t('search')"
                        v-model="search.title"
                        clearable
                        outlined
                        />
                    </q-td>
                    <q-td style="width: 20%">
                        <q-select
                        dense
                        :label="$t('search')"
                        v-model="search.category"
                        clearable
                        :options="vulnCategoriesOptions"
                        options-sanitize
                        outlined
                        />
                    </q-td>
                    <q-td style="width: 20%">
                        <q-select
                        dense
                        :label="$t('search')"
                        v-model="search.vulnType"
                        clearable
                        :options="vulnTypeOptions"
                        options-sanitize
                        outlined
                        />
                    </q-td>
                    <q-td></q-td>
                </q-tr>
            </template>

            <template v-slot:body="props">
                <q-tr :props="props">
                    <q-td key="title" :props="props">
                        {{props.row.detail.title}}
                        <q-btn dense round flat :icon="props.expand ? 'arrow_drop_up' : 'arrow_drop_down'" @click="props.expand = !props.expand" />
                    </q-td>
                    <q-td key="category" :props="props">
                        {{props.row.category || $t('noCategory')}}
                    </q-td>
                    <q-td key="vulnType" :props="props">
                        {{props.row.detail.vulnType || $t('undefined')}}
                    </q-td>
                    <q-td key="action" :props="props" style="width:1px">
                        <q-btn flat color="primary" icon="fa fa-plus-circle" @click="addFindingFromVuln(props.row)">
                            <q-tooltip anchor="bottom middle" self="center left" :delay="500" content-class="text-bold">{{$t('tooltip.addToFindings')}}</q-tooltip>                            
                        </q-btn>
                    </q-td>
                </q-tr>
                <q-tr v-show="props.expand" :props="props">
                    <q-td colspan="100%" class="bg-grey-4">
                        <div class="editor__content" style="white-space: initial" v-html="htmlEncode(props.row.detail.description)"></div>
                    </q-td>
                </q-tr>
            </template>

            <template v-slot:bottom="scope">
                <span v-if="vulnerabilities.length === 1">{{filteredRowsCount}} / 1 {{$t('vulnerabilityNum1')}}</span>                
                <span v-else>{{filteredRowsCount}} / {{vulnerabilities.length}} {{$t('vulnerabilitiesNums')}}</span>  
                <q-space />
                <span>{{$t('resultsPerPage')}}</span>
                <q-select
                class="q-px-md"
                v-model="vulnPagination.rowsPerPage"
                :options="rowsPerPageOptions"
                emit-value
                map-options
                dense
                options-dense
                options-cover
                borderless
                />
                <q-pagination input v-model="vulnPagination.page" :max="scope.pagesNumber" />            
            </template> 
    
        </q-table>
    </div>
</div>

<!-- AI Input Modal -->
<q-dialog ref="aiModal" persistent @hide="closeAiModal()">
    <q-card style="width: 600px; max-width: 600px;">
        <q-bar class="bg-fixed-primary text-white">
            <div class="q-toolbar-title">
                {{$t('createVulnerabilityIA')}}
            </div>
            <q-space />
            <q-btn dense flat icon="close" @click="$refs.aiModal.hide()" />
        </q-bar>

        <q-card-section>
            <q-input
            :label="$t('title')"
            v-model="aiTitle"
            outlined
            autofocus
            class="q-mb-md"
            :placeholder="$t('vulnerabilityTitle')"
            />
            <q-select
            :label="$t('language')"
            v-model="aiLanguage"
            :options="aiLanguageOptions"
            option-value="value"
            option-label="label"
            map-options
            emit-value
            outlined
            class="q-mb-md"
            />
            <q-input
            :label="$t('description')"
            v-model="aiDescription"
            type="textarea"
            rows="6"
            outlined
            :placeholder="$t('describeVulnerability')"
            />
        </q-card-section>

        <q-separator />

        <q-card-actions align="right">
            <q-btn color="primary" outline @click="$refs.aiModal.hide()">{{$t('btn.cancel')}}</q-btn>
            <q-btn color="secondary" unelevated @click="createWithAI()" :loading="aiLoading" :disable="!aiTitle.trim() && !aiDescription.trim()">{{$t('btn.create')}}</q-btn>
        </q-card-actions>
    </q-card>
</q-dialog>

<!-- Create/Review Modal -->
<q-dialog ref="createModal" maximized position="right" persistent @hide="closeCreateModal()">
    <q-card :style="($q.screen.gt.lg)?'width: 50vw':'width:1000px'">
        <q-bar class="bg-fixed-primary text-white">
            <div class="q-toolbar-title">
                {{$t('createFinding')}}
            </div>
            <q-space />
            <q-btn dense flat icon="close" @click="$refs.createModal.hide()" />
        </q-bar>

        <q-card-section>
            <div class="q-col-gutter-md row">
                <q-input
                :label="$t('title')+' *'"
                stack-label
                class="col-md-8"
                autofocus
                v-model="aiFinding.title"
                outlined
                />
                <q-select
                class="col-md-4"
                :label="$t('category')"
                v-model="aiFinding.category"
                :options="vulnCategories"
                option-value="name"
                option-label="name"
                clearable
                options-sanitize
                outlined
                />
            </div>
        </q-card-section>
        <q-card-section>
            <q-field borderless :label="$t('description')" stack-label>
                <template v-slot="control">
                    <basic-editor noAffix v-model="aiFinding.description" />
                </template>
            </q-field>
        </q-card-section>
        <q-card-section>
            <q-field borderless :label="$t('observation')" stack-label>
                <template v-slot="control">
                    <basic-editor noAffix v-model="aiFinding.observation" />
                </template>
            </q-field>
        </q-card-section>
        <q-card-section v-if="$settings.report.public.scoringMethods.CVSS3">
            <div class="col-md-12">
                <cvss3-calculator v-model="aiFinding.cvssv3" />
            </div>
        </q-card-section>
        <q-card-section v-if="$settings.report.public.scoringMethods.CVSS4">
            <div class="col-md-12">
                <cvss4-calculator v-model="aiFinding.cvssv4" />
            </div>
        </q-card-section>
        <q-card-section>
            <q-field borderless :label="$t('remediation')" stack-label>
                <template v-slot="control">
                    <basic-editor noAffix v-model="aiFinding.remediation" />
                </template>
            </q-field>
        </q-card-section>
        <q-card-section>
            <div class="q-col-gutter-md row">
                <q-select
                :label="$t('remediationComplexity')"
                stack-label
                class="col-md-6"
                v-model="aiFinding.remediationComplexity"
                :options="[{label: $t('easy'), value: 1},{label: $t('medium'), value: 2},{label: $t('complex'), value: 3}]"
                map-options
                emit-value
                options-sanitize
                outlined
                />
                <q-select
                :label="$t('remediationPriority')"
                stack-label
                class="col-md-6"
                v-model="aiFinding.priority"
                :options="[{label: $t('low'), value: 1},{label: $t('medium'), value: 2},{label: $t('high'), value: 3},{label: $t('urgent'), value: 4}]"
                map-options
                emit-value
                options-sanitize
                outlined
                />
            </div>
        </q-card-section>
        <q-card-section>
            <textarea-array :label="$t('references')" v-model="aiFinding.references" />
        </q-card-section>

        <q-separator />

        <q-card-actions align="right">
            <q-btn color="primary" outline @click="$refs.createModal.hide()">{{$t('btn.cancel')}}</q-btn>
            <q-btn color="secondary" unelevated @click="createFindingFromAI()">{{$t('btn.create')}}</q-btn>
        </q-card-actions>
    </q-card>
</q-dialog>
</div>